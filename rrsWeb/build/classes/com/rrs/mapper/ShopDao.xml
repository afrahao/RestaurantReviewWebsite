<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rrs.mapper.ShopDao">


	<!-- 返回restaurant数量 -->
    <select id="getRestaurantNum" resultType="Integer">
        select count(*) from business
    </select>
    
	<!-- 返回一些restaurant -->
    <select id="getRestaurant" parameterType="Integer" resultType="com.rrs.pojo.Restaurant">
        select * from business LIMIT #{0},#{1}
    </select>
    <!-- 返回restaurant By key -->
    <select id="getRestaurantSearch" parameterType="String" resultType="com.rrs.pojo.Restaurant">               
        select * from business where business.name like CONCAT('%',#{key},'%')      
    </select>
    
    <select id="getRestaurantSearchNum" parameterType="String" resultType="Integer" >
        select count(*) from business where business.name like CONCAT('%',#{key},'%') 
    </select>
    
     <!-- 返回single By name -->
    <select id="getRestaurantImg" parameterType="String" resultType="String">               
        select photo.id as img from photo where photo.business_id=#{shop_id}
    </select>
    
    <!-- 返回single By id -->
    <select id="getRestaurantById" parameterType="String" resultType="Restaurant">               
        select * from business where business.id = #{0}
    </select>
    
    <!-- 返回某个饭店的所有attribute -->
     <select id="getAttributes" parameterType="String" resultType="com.rrs.pojo.Attribute" >
        select * from attribute where business_id = #{0} 
    </select>
    
    <!-- 返回某个饭店的所有category -->
     <select id="getCategoryList" parameterType="String" resultType="String" >
        select category from category,business_cate where category.id = business_cate.category_id and business_id=#{0}
    </select>
   
   <!-- 返回某个饭店的所有hour -->
     <select id="getHourList" parameterType="String" resultType="String" >
        select hours from hours where business_id=#{0}
    </select>
   
   
     <!-- 返回某个饭店的所有review -->
     <select id="getReviewList" parameterType="String" resultType="com.rrs.pojo.Review" >
        select user.name as user_name,review.* from review,user where business_id=#{0} and review.user_id=user.id
    </select>
   
    <!-- 获取当前类别的餐馆 -->
    <select id="selectBusinessByCate" parameterType="int" resultType="com.rrs.pojo.Restaurant">
        select * from  business
        <where>
            id in select business_id from business_cate
            <where>
            	category_id = #{0}
            </where>
        </where>
    </select>
    
    <!-- 返回距离指定地点指定范围的restaurant -->
    <select id="getRestaurantByDistance1" resultType="com.rrs.pojo.Restaurant">
	    SELECT 
	    *,
	    photo.id as img,
	    ROUND(
	        6378.138 * 2 * ASIN(
	            SQRT(
	                POW(
	                    SIN(
	                        (
	                            #{0} * PI() / 180 - latitude * PI() / 180
	                        ) / 2
	                    ),
	                    2
	                ) + COS(#{0} * PI() / 180) * COS(latitude * PI() / 180) * POW(
	                    SIN(
	                        (
	                            #{1} * PI() / 180 - longitude * PI() / 180
	                        ) / 2
	                    ),
	                    2
	                )
	            )
	        ) * 1000
	    ) AS distance
	FROM
	    business,photo
	where business.id=photo.business_id
	HAVING
		distance &lt;= #{2}
	ORDER BY
	    distance ASC
	LIMIT 1,150
    </select> 
    <!-- 返回距离指定地点指定范围的restaurant -->
    <select id="getRestaurantByDistance2" resultType="com.rrs.pojo.Restaurant">
	    SELECT 
	    *,
	    photo.id as img,
	    ROUND(
	        6378.138 * 2 * ASIN(
	            SQRT(
	                POW(
	                    SIN(
	                        (
	                            #{0} * PI() / 180 - latitude * PI() / 180
	                        ) / 2
	                    ),
	                    2
	                ) + COS(#{0} * PI() / 180) * COS(latitude * PI() / 180) * POW(
	                    SIN(
	                        (
	                            #{1} * PI() / 180 - longitude * PI() / 180
	                        ) / 2
	                    ),
	                    2
	                )
	            )
	        ) * 1000
	    ) AS distance
	FROM
	    business,photo
	where business.id=photo.business_id
	HAVING
		distance &lt;= #{3} and  distance &gt;= #{2}
	ORDER BY
	    distance ASC
	LIMIT 1,150
    </select> 
    <!-- 返回距离指定地点指定范围的restaurant -->
    <select id="getRestaurantByDistance3" resultType="com.rrs.pojo.Restaurant">
	    SELECT 
	    *,
	    photo.id as img,
	    ROUND(
	        6378.138 * 2 * ASIN(
	            SQRT(
	                POW(
	                    SIN(
	                        (
	                            #{0} * PI() / 180 - latitude * PI() / 180
	                        ) / 2
	                    ),
	                    2
	                ) + COS(#{0} * PI() / 180) * COS(latitude * PI() / 180) * POW(
	                    SIN(
	                        (
	                            #{1} * PI() / 180 - longitude * PI() / 180
	                        ) / 2
	                    ),
	                    2
	                )
	            )
	        ) * 1000
	    ) AS distance
	FROM
	    business,photo
	where business.id=photo.business_id
	HAVING
		distance &gt;= #{2}
	ORDER BY
	    distance ASC
	LIMIT 1,150
    </select> 
    
    
    
    

</mapper>